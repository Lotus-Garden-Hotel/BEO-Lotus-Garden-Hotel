<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banquet Analytics - V.6.4 [Full Sync]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        :root { --bg: #020617; --card: rgba(255, 255, 255, 0.05); }
        body.night-mode { --bg: #000000 !important; --card: rgba(15, 23, 42, 0.8) !important; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f8fafc; padding: 15px; transition: 0.3s; min-height: 100vh; padding-bottom: 30px; }
        .card-base { background: var(--card); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 1.5rem; padding: 15px; }
        .btn-nav:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body>
    <div class="flex items-center justify-between mb-6 px-1">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='index.html'" class="btn-nav bg-white/10 px-3 py-1.5 rounded-xl text-indigo-400 font-bold text-[10px] border border-white/5 tracking-tighter">‚Üê DASHBOARD</button>
            <h1 class="text-lg font-black uppercase italic tracking-tighter">Analytics <span class="text-indigo-500 text-xs">V.6.4</span></h1>
        </div>
        <button onclick="toggleNightMode()" class="text-xs">üåô</button>
    </div>

    <div class="space-y-4">
        <div class="card-base">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest leading-none mb-1">Revenue Stream</p>
                    <h2 class="text-xs font-bold text-indigo-300">Monthly Achievement (%)</h2>
                </div>
                <div class="text-right">
                    <p id="total-annual" class="text-[12px] font-black text-emerald-400">Rp0</p>
                    <p class="text-[7px] font-bold text-slate-500 uppercase leading-none">Nett YTD (Conf+Done)</p>
                </div>
            </div>
            <div class="relative h-[280px]"><canvas id="revenueChart"></canvas></div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div class="card-base text-center border-b-2 border-emerald-500 py-3">
                <p class="text-[7px] font-black text-slate-500 uppercase mb-1 tracking-widest">Annual Progress</p>
                <h2 id="annual-progress" class="text-lg font-black text-emerald-400">0%</h2>
            </div>
            <div class="card-base text-center border-b-2 border-amber-500 py-3">
                <p class="text-[7px] font-black text-slate-500 uppercase mb-1 tracking-widest">Total Pax YTD</p>
                <h2 id="total-pax-count" class="text-lg font-black text-amber-400">0</h2>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div class="card-base text-center border-b-2 border-indigo-500 py-3">
                <p class="text-[7px] font-black text-slate-500 uppercase mb-1 tracking-widest">Avg Achievement</p>
                <h2 id="avg-ach" class="text-lg font-black text-indigo-400">0%</h2>
            </div>
            <div class="card-base text-center border-b-2 border-slate-700 py-3">
                <p class="text-[7px] font-black text-slate-500 uppercase mb-1 tracking-widest">Total Intensity (All)</p>
                <h2 id="total-event-count" class="text-lg font-black text-white">0</h2>
            </div>
        </div>

        <div class="card-base">
            <p class="text-[8px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4 text-center">Venues Usage Intensity (Confirm+Done+Tentative)</p>
            <div id="venue-list" class="grid grid-cols-2 gap-2"></div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyBZjSmOA81ftVsIJT5etEL19NjPdYTVSQk';
        const SHEET_ID = '1MXwfVXORuTd125BCkKYP_mHC_6O_Z1mZcGno2VCGOeE';
        const RANGE = 'Summary!A1:P200';
        Chart.register(ChartDataLabels);

        window.onload = () => {
            const savedMode = localStorage.getItem('nightMode');
            if (savedMode === 'enabled') document.body.classList.add('night-mode');
            setTimeout(fetchData, 50);
        };

        async function fetchData() {
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
                const data = await res.json();
                const rows = data.values;
                
                let budgetData = []; let totalBudgetSetahun = 0;
                for(let i=88; i<=99; i++) { 
                    const bVal = cleanVal(rows[i]?.[1]); 
                    budgetData.push(bVal); 
                    totalBudgetSetahun += bVal; 
                }
                
                let realData = new Array(12).fill(0); 
                let totalIntensityCount = 0, annualNett = 0, totalPax = 0;
                let venueMap = {};

                for(let i=26; i<=200; i++) {
                    const r = rows[i]; if(!r || !r[9] || !r[13]) continue;
                    const sStat = r[13].toUpperCase();
                    const nett = cleanVal(r[14]) / 1.21;
                    const pax = cleanVal(r[11]);
                    const venue = (r[15] || 'TBD').toUpperCase().trim();
                    const [dP, mP] = r[9].split('/');
                    const m = parseInt(mP);

                    // SINKRONISASI LOGIC: ALL STATUS untuk Intensity & Performance
                    if(sStat.includes("CONFIRM") || sStat.includes("DONE") || sStat.includes("TENTATIVE")) {
                        if(m >= 1 && m <= 12) {
                            // Hitung Revenue (Biasanya confirm/done saja untuk nett, tapi ini kita samakan dengan dashboard ALL)
                            realData[m-1] += nett;
                            annualNett += nett;
                            totalPax += pax;
                            totalIntensityCount++;
                            venueMap[venue] = (venueMap[venue] || 0) + 1;
                        }
                    }
                }

                const achData = realData.map((val, i) => budgetData[i] > 0 ? Math.round((val / budgetData[i]) * 100) : 0);
                let totalAch = 0, activeMonths = 0;
                achData.forEach((v, i) => { if(realData[i] > 0 || budgetData[i] > 0) { totalAch += v; activeMonths++; } });
                
                // UPDATE SEMUA KOTAK SUMMARY (RESTORED)
                document.getElementById('annual-progress').innerText = (totalBudgetSetahun > 0 ? Math.round((annualNett / totalBudgetSetahun) * 100) : 0) + "%";
                document.getElementById('avg-ach').innerText = Math.round(totalAch / (activeMonths || 1)) + "%";
                document.getElementById('total-event-count').innerText = totalIntensityCount;
                document.getElementById('total-pax-count').innerText = totalPax.toLocaleString('id-ID');
                document.getElementById('total-annual').innerText = "Rp" + Math.round(annualNett).toLocaleString('id-ID');

                // RENDER VENUE DENGAN LINK SINKRON
                const venueContainer = document.getElementById('venue-list');
                let venueHtml = '';
                Object.entries(venueMap).sort((a,b) => b[1] - a[1]).forEach(([name, val]) => {
                    venueHtml += `
                        <a href="index.html?venue=${encodeURIComponent(name)}" class="bg-white/5 border border-white/10 rounded-xl p-2.5 flex justify-between items-center hover:bg-indigo-500/10 transition-all cursor-pointer">
                            <span class="text-[9px] font-bold text-slate-300 truncate pr-2 tracking-tight">${name}</span>
                            <span class="text-[11px] font-black text-indigo-400">${val}<span class="text-[7px] ml-0.5 opacity-60 italic">√ó</span></span>
                        </a>`;
                });
                venueContainer.innerHTML = venueHtml || '<p class="col-span-2 text-center text-[10px] py-4 opacity-20 italic">No Data</p>';

                renderChart(realData, budgetData, achData);
            } catch (e) { console.error(e); }
        }

        function renderChart(real, bud, ach) {
            const isNight = document.body.classList.contains('night-mode');
            const ctx = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['JAN', 'FEB', 'MAR', 'APR', 'MEI', 'JUN', 'JUL', 'AGU', 'SEP', 'OKT', 'NOV', 'DES'],
                    datasets: [
                        {
                            label: 'Actual Nett', data: real, backgroundColor: '#6366f1', borderRadius: 4,
                            datalabels: { anchor: 'end', align: 'top', color: isNight ? '#818cf8' : '#4f46e5', font: { weight: '900', size: 9 }, formatter: (v, ctx) => ach[ctx.dataIndex] + '%' }
                        },
                        { label: 'Budget', data: bud, backgroundColor: isNight ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)', borderRadius: 4, datalabels: { display: false } }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: false }, ticks: { display: false } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 8, weight: '700' } } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: isNight ? '#f8fafc' : '#1e293b', font: { size: 9 }, usePointStyle: true } } }
                }
            });
        }
        function cleanVal(s) { return parseFloat((s || "0").toString().replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0; }
        function toggleNightMode() {
            const isNight = document.body.classList.toggle('night-mode');
            localStorage.setItem('nightMode', isNight ? 'enabled' : 'disabled');
            fetchData();
        }
    </script>
</body>
</html>
